<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI新闻海报生成器</title>
    <style>
        body {
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #333;
            background: linear-gradient(135deg, #121212 0%, #2b2b2b 100%);
            color: #f0f0f0;
        }
        .container {
            max-width: 800px;
            width: 100%;
            text-align: center;
        }
        h1 {
            color: #00aeff;
            margin-bottom: 30px;
            font-size: 2.5rem;
            text-shadow: 0 0 15px rgba(0, 174, 255, 0.5);
        }
        .poster-container {
            margin: 20px 0;
            display: flex;
            justify-content: center;
        }
        #ai-poster {
            width: 100%;
            max-width: 500px;
            height: auto;
            display: none;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 174, 255, 0.3);
            transition: transform 0.3s;
        }
        #ai-poster:hover {
            transform: scale(1.02);
        }
        .generate-btn {
            background: linear-gradient(45deg, #00aeff 0%, #0066ff 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            font-size: 18px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            margin: 20px 0;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0, 174, 255, 0.4);
            position: relative;
            overflow: hidden;
        }
        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 174, 255, 0.6);
        }
        .generate-btn::after {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: rotate(45deg);
            transition: 0.5s;
        }
        .generate-btn:hover::after {
            left: 100%;
            top: 100%;
        }
        .download-btn {
            background: linear-gradient(45deg, #00c853 0%, #64dd17 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            font-size: 18px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            margin: 20px 0;
            display: none;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(100, 221, 23, 0.4);
            position: relative;
            overflow: hidden;
        }
        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(100, 221, 23, 0.6);
        }
        .download-btn::after {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: rotate(45deg);
            transition: 0.5s;
        }
        .download-btn:hover::after {
            left: 100%;
            top: 100%;
        }
        .features {
            text-align: left;
            margin: 30px 0;
            background: rgba(255, 255, 255, 0.03);
            padding: 25px 35px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .features h3 {
            color: #00aeff;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 10px;
            text-shadow: 0 0 10px rgba(0, 174, 255, 0.3);
        }
        .features ul {
            padding-left: 20px;
        }
        .features li {
            margin-bottom: 12px;
            position: relative;
            padding-left: 5px;
        }
        .badge {
            display: inline-block;
            background: linear-gradient(45deg, #ff4081 0%, #ff6e40 100%);
            color: white;
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 15px;
            margin-left: 8px;
            vertical-align: middle;
            box-shadow: 0 2px 6px rgba(255, 64, 129, 0.4);
        }
        .logo-upload {
            margin: 20px 0;
            text-align: center;
        }
        .logo-label {
            display: inline-block;
            background: linear-gradient(45deg, #673ab7 0%, #9c27b0 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(156, 39, 176, 0.3);
        }
        .logo-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(156, 39, 176, 0.5);
        }
        #logo-file {
            display: none;
        }
        #logo-preview {
            max-width: 100px;
            max-height: 100px;
            margin-top: 10px;
            border-radius: 8px;
            display: none;
        }
        /* 添加编辑功能的样式 */
        .edit-btn {
            background: linear-gradient(45deg, #ff9800 0%, #ff5722 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            margin: 20px 0;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4);
        }
        .edit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 152, 0, 0.5);
        }
        .news-editor {
            display: none;
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 16px;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .news-editor h3 {
            color: #00aeff;
            margin-bottom: 15px;
        }
        .news-item-editor {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            text-align: left;
        }
        .news-editor input, .news-editor textarea {
            width: 100%;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
        }
        .news-editor label {
            display: block;
            margin-top: 10px;
            color: #aaa;
            text-align: left;
            font-size: 0.9em;
        }
        .date-editor {
            margin-bottom: 20px;
        }
        .save-btn {
            background: linear-gradient(45deg, #4caf50 0%, #8bc34a 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 15px;
            font-weight: bold;
        }
        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.5);
        }
        /* 添加JSON编辑器样式 */
        .json-editor {
            display: none;
            margin-top: 20px;
        }
        .json-textarea {
            width: 100%;
            height: 300px;
            background: rgba(0, 0, 0, 0.2);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            font-family: monospace;
            resize: vertical;
        }
        .editor-tabs {
            display: flex;
            margin-bottom: 15px;
        }
        .editor-tab {
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            border: none;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
            opacity: 0.7;
        }
        .editor-tab.active {
            background: rgba(0, 174, 255, 0.3);
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🌟 AI科技前沿快报 🚀</h1>
        <p>一键生成科技感十足的AI新闻海报，随时掌握全球AI最新动态！</p>
        <p style="color: #00aeff; font-size: 0.9em;">提示：请上传Logo图片以获得最佳体验</p>
        
        <div class="logo-upload">
            <label for="logo-file" class="logo-label">📷 选择Logo图片</label>
            <input type="file" id="logo-file" accept="image/*">
            <div>
                <img id="logo-preview" alt="Logo预览">
            </div>
        </div>
        
        <button id="edit-news-btn" class="edit-btn">✏️ 编辑新闻内容</button>
        <button id="generate-btn" class="generate-btn">✨ 生成高科技AI新闻海报 ✨</button>
        
        <div class="poster-container">
            <canvas id="poster-canvas" style="display:none;"></canvas>
            <img id="ai-poster" alt="AI新闻海报">
        </div>
        
        <a id="download-btn" class="download-btn" download="AI新闻海报.png">📲 下载海报分享到朋友圈</a>
        
        <!-- 新闻编辑器 -->
        <div id="news-editor" class="news-editor">
            <h3>编辑新闻内容</h3>
            
            <div class="editor-tabs">
                <button class="editor-tab active" id="form-editor-tab">表单编辑</button>
                <button class="editor-tab" id="json-editor-tab">JSON编辑</button>
            </div>
            
            <div id="form-editor">
                <div class="date-editor">
                    <label for="news-date">日期:</label>
                    <input type="text" id="news-date" placeholder="例如：2025年3月26日">
                </div>
                
                <div id="news-items-container">
                    <!-- 新闻项编辑区域会通过JavaScript动态生成 -->
                </div>
                
                <div>
                    <label for="hashtags">话题标签 (用逗号分隔):</label>
                    <input type="text" id="hashtags" placeholder="例如：人工智能,科技前沿,AI革命,数字化未来">
                </div>
            </div>
            
            <div id="json-editor" class="json-editor">
                <p>直接编辑JSON格式的新闻数据：</p>
                <textarea id="json-textarea" class="json-textarea" spellcheck="false"></textarea>
            </div>
            
            <button id="save-news-btn" class="save-btn">💾 保存修改</button>
        </div>
        
        <div class="features">
            <h3>📊 本期精选AI前沿资讯 📊</h3>
            <ul id="news-list">
                <!-- 新闻列表会通过JavaScript动态生成 -->
            </ul>
        </div>
    </div>

    <script>
        // 新闻数据配置 - 每天只需要更新这里的内容
        const newsData = {
            date: '2025年3月26日',
            items: [
                {
                    emoji: '🔥',
                    title: 'DeepSeek V3-0324：开源AI新巅峰',
                    content: [
                        '中国AI初创公司最新模型成为首个在非推理模型基准测试中',
                        '登顶的开源AI。苹果CEO库克评价："非常卓越"。'
                    ],
                    badge: '独家'
                },
                {
                    emoji: '🚀',
                    title: 'ARC-AGI-2：最严苛AI基准测试发布',
                    content: [
                        'ARC Prize推出的新基准测试被认为是目前评估AGI能力的',
                        '最高标准，将成为判断AI接近人类水平的关键指标。'
                    ]
                },
                {
                    emoji: '🌐',
                    title: 'Claude获得网页搜索能力重大升级',
                    content: [
                        'Anthropic为其AI助手Claude添加实时网页搜索功能，',
                        '显著提升回应质量和准确性，提高时效性。'
                    ],
                    badge: '热门'
                },
                {
                    emoji: '🏆',
                    title: '全球AI格局报告：多极化趋势明显',
                    content: [
                        '最新研究显示，全球AI发展呈多极化趋势，中国和欧盟在',
                        '特定AI领域已实现赶超，全球创新中心多元化发展。'
                    ]
                },
                {
                    emoji: '🧠',
                    title: '神经多样性提升AI系统创造力与公平性',
                    content: [
                        '研究表明，融合不同思维方式的开发团队创造的AI系统',
                        '创造性提升35%，系统性偏见减少40%。'
                    ]
                },
                {
                    emoji: '🛡️',
                    title: 'AI安全技术取得突破性进展',
                    content: [
                        '最新防御技术使AI模型抵御干扰能力提升10倍，拒绝有害',
                        '指令准确率达99.7%，为AI应用提供更可靠的安全保障。'
                    ],
                    badge: '新增'
                },
                {
                    emoji: '🔮',
                    title: 'AI医疗诊断超越专家团队共识',
                    content: [
                        '新一代AI诊断系统在盲测中准确率超过专家团队5%，能够',
                        '识别人类医生易忽略的早期症状，大幅提升早诊率。'
                    ],
                    badge: '重要'
                }
            ],
            hashtags: ['人工智能', '科技前沿', 'AI革命', '数字化未来']
        };

        // 更新页面上的新闻列表
        function updateNewsList() {
            const newsList = document.getElementById('news-list');
            newsList.innerHTML = ''; // 清空现有内容
            
            newsData.items.forEach(item => {
                const li = document.createElement('li');
                let content = item.emoji + ' ' + item.title;
                
                if (item.badge) {
                    content += `<span class="badge">${item.badge}</span>`;
                }
                
                li.innerHTML = content;
                newsList.appendChild(li);
            });
        }

        // 初始化页面时更新新闻列表
        updateNewsList();
        
        // 初始化编辑器
        function initNewsEditor() {
            // 设置日期
            document.getElementById('news-date').value = newsData.date;
            
            // 设置标签
            document.getElementById('hashtags').value = newsData.hashtags.join(',');
            
            // 清空现有的新闻项编辑区域
            const container = document.getElementById('news-items-container');
            container.innerHTML = '';
            
            // 为每条新闻创建编辑区域
            newsData.items.forEach((item, index) => {
                const itemEditor = document.createElement('div');
                itemEditor.className = 'news-item-editor';
                
                const html = `
                    <label for="news-emoji-${index}">表情:</label>
                    <input type="text" id="news-emoji-${index}" value="${item.emoji}" placeholder="表情符号">
                    
                    <label for="news-title-${index}">标题:</label>
                    <input type="text" id="news-title-${index}" value="${item.title}" placeholder="新闻标题">
                    
                    <label for="news-content1-${index}">内容第一行:</label>
                    <textarea id="news-content1-${index}" placeholder="新闻内容第一行">${item.content[0] || ''}</textarea>
                    
                    <label for="news-content2-${index}">内容第二行:</label>
                    <textarea id="news-content2-${index}" placeholder="新闻内容第二行">${item.content[1] || ''}</textarea>
                    
                    <label for="news-badge-${index}">标签 (可选):</label>
                    <input type="text" id="news-badge-${index}" value="${item.badge || ''}" placeholder="例如：热门、独家">
                `;
                
                itemEditor.innerHTML = html;
                container.appendChild(itemEditor);
            });
            
            // 初始化JSON编辑器
            const jsonEditor = document.getElementById('json-textarea');
            jsonEditor.value = JSON.stringify(newsData, null, 2);
        }
        
        // 从表单保存新闻数据
        function saveNewsDataFromForm() {
            // 更新日期
            newsData.date = document.getElementById('news-date').value;
            
            // 更新标签
            const hashtagsInput = document.getElementById('hashtags').value;
            newsData.hashtags = hashtagsInput.split(',').map(tag => tag.trim()).filter(tag => tag);
            
            // 更新新闻项
            const newsItems = [];
            for (let i = 0; i < newsData.items.length; i++) {
                const emoji = document.getElementById(`news-emoji-${i}`).value;
                const title = document.getElementById(`news-title-${i}`).value;
                const content1 = document.getElementById(`news-content1-${i}`).value;
                const content2 = document.getElementById(`news-content2-${i}`).value;
                const badge = document.getElementById(`news-badge-${i}`).value;
                
                newsItems.push({
                    emoji: emoji,
                    title: title,
                    content: [content1, content2],
                    badge: badge || undefined
                });
            }
            
            newsData.items = newsItems;
        }
        
        // 从JSON编辑器保存新闻数据
        function saveNewsDataFromJson() {
            try {
                const jsonText = document.getElementById('json-textarea').value;
                const newData = JSON.parse(jsonText);
                
                // 验证数据格式
                if (!newData.date || !Array.isArray(newData.items) || !Array.isArray(newData.hashtags)) {
                    throw new Error('JSON格式不正确，必须包含date、items数组和hashtags数组');
                }
                
                // 更新newsData
                newsData.date = newData.date;
                newsData.items = newData.items;
                newsData.hashtags = newData.hashtags;
                
                return true;
            } catch (error) {
                alert('JSON格式错误: ' + error.message);
                return false;
            }
        }
        
        // 保存编辑后的新闻数据
        function saveNewsData() {
            const activeTab = document.querySelector('.editor-tab.active').id;
            
            let success = true;
            if (activeTab === 'form-editor-tab') {
                saveNewsDataFromForm();
            } else if (activeTab === 'json-editor-tab') {
                success = saveNewsDataFromJson();
            }
            
            if (success) {
                // 更新页面显示
                updateNewsList();
                
                // 隐藏编辑器
                document.getElementById('news-editor').style.display = 'none';
                
                // 显示成功消息
                alert('新闻内容已更新！');
            }
        }
        
        // 切换编辑器标签页
        document.getElementById('form-editor-tab').addEventListener('click', function() {
            document.getElementById('form-editor').style.display = 'block';
            document.getElementById('json-editor').style.display = 'none';
            document.getElementById('form-editor-tab').classList.add('active');
            document.getElementById('json-editor-tab').classList.remove('active');
            
            // 同步JSON编辑器的内容到表单
            try {
                saveNewsDataFromJson();
                initNewsEditor();
            } catch (e) {
                // 如果JSON无效，不进行同步
            }
        });
        
        document.getElementById('json-editor-tab').addEventListener('click', function() {
            document.getElementById('form-editor').style.display = 'none';
            document.getElementById('json-editor').style.display = 'block';
            document.getElementById('form-editor-tab').classList.remove('active');
            document.getElementById('json-editor-tab').classList.add('active');
            
            // 同步表单内容到JSON编辑器
            saveNewsDataFromForm();
            document.getElementById('json-textarea').value = JSON.stringify(newsData, null, 2);
        });
        
        // 绑定编辑按钮事件
        document.getElementById('edit-news-btn').addEventListener('click', function() {
            initNewsEditor();
            document.getElementById('news-editor').style.display = 'block';
            document.getElementById('form-editor').style.display = 'block';
            document.getElementById('json-editor').style.display = 'none';
            document.getElementById('form-editor-tab').classList.add('active');
            document.getElementById('json-editor-tab').classList.remove('active');
        });
        
        // 绑定保存按钮事件
        document.getElementById('save-news-btn').addEventListener('click', saveNewsData);
        
        // Logo上传预览
        document.getElementById('logo-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('logo-preview');
                    preview.src = e.target.result;
                    preview.style.display = 'inline-block';
                }
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('generate-btn').addEventListener('click', generatePoster);
        
        function generatePoster() {
            const canvas = document.getElementById('poster-canvas');
            const ctx = canvas.getContext('2d');
            
            // 设置画布大小
            canvas.width = 1000;  // 增加画布宽度
            canvas.height = 2000; // 增加画布高度
            
            // 获取用户上传的logo
            const logoPreview = document.getElementById('logo-preview');
            
            // 检查用户是否上传了logo
            if (logoPreview.style.display === 'inline-block' && logoPreview.complete) {
                // 用户上传了logo并且图片已加载完成
                renderPosterWithLogo(ctx, canvas, logoPreview);
            } else {
                // 用户没有上传logo，使用生成的纯色logo
                const generatedLogo = generateColorLogo(ctx);
                renderPosterWithLogo(ctx, canvas, generatedLogo);
            }
        }
        
        function renderPosterWithLogo(ctx, canvas, logoImage) {
            // 绘制背景
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#0a1929');
            gradient.addColorStop(0.5, '#0f2547');
            gradient.addColorStop(1, '#1e1033');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // 添加科技感线条和粒子
            drawTechPattern(ctx, canvas.width, canvas.height);
            
            // 绘制标题区背景
            ctx.fillStyle = 'rgba(0, 20, 50, 0.7)';
            ctx.fillRect(0, 40, canvas.width, 200);
            
            // 添加标题光效
            const glowGradient = ctx.createLinearGradient(0, 40, 0, 240);
            glowGradient.addColorStop(0, 'rgba(0, 174, 255, 0.15)');
            glowGradient.addColorStop(1, 'rgba(0, 174, 255, 0)');
            ctx.fillStyle = glowGradient;
            ctx.fillRect(0, 40, canvas.width, 200);
            
            try {
                // 添加logo在左上角
                const logoSize = 100;
                ctx.drawImage(logoImage, 50, 80, logoSize, logoSize);
            } catch (error) {
                console.error('无法绘制Logo:', error);
                // 如果绘制logo出错，继续生成其他部分
            }
            
            // 添加标题
            ctx.fillStyle = 'white';
            ctx.font = 'bold 62px "PingFang SC", "Microsoft YaHei", sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(newsData.date, canvas.width / 2, 120);
            
            ctx.font = 'bold 74px "PingFang SC", "Microsoft YaHei", sans-serif';
            // 创建渐变标题
            const titleGradient = ctx.createLinearGradient(200, 0, 800, 0);
            titleGradient.addColorStop(0, '#00aeff');  
            titleGradient.addColorStop(1, '#64eeff');
            ctx.fillStyle = titleGradient;
            
            // 添加轻微的标题阴影
            ctx.shadowColor = 'rgba(0, 174, 255, 0.6)';
            ctx.shadowBlur = 15;
            ctx.fillText('AI科技前沿速递', canvas.width / 2, 200);
            ctx.shadowBlur = 0;
            
            // 添加分隔线
            const lineGradient = ctx.createLinearGradient(100, 0, 900, 0);
            lineGradient.addColorStop(0, 'rgba(0, 174, 255, 0)');
            lineGradient.addColorStop(0.5, 'rgba(0, 174, 255, 1)');
            lineGradient.addColorStop(1, 'rgba(0, 174, 255, 0)');
            
            ctx.strokeStyle = lineGradient;
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(50, 260);
            ctx.lineTo(canvas.width - 50, 260);
            ctx.stroke();
            
            try {
                // 绘制新闻框
                drawNewsBoxes(ctx, canvas);
            } catch (error) {
                console.error('绘制新闻框时出错:', error);
                // 即使绘制新闻框出错也要继续显示海报
            }
            
            try {
                // 显示生成的海报
                const posterImg = document.getElementById('ai-poster');
                try {
                    posterImg.src = canvas.toDataURL('image/png');
                } catch (securityError) {
                    console.error('Canvas安全错误:', securityError);
                    // 无法使用toDataURL，显示备用信息
                    displayFallbackPoster(canvas, posterImg);
                    return; // 提前返回，避免后续代码执行
                }
                posterImg.style.display = 'block';
                
                // 显示下载按钮
                const downloadBtn = document.getElementById('download-btn');
                downloadBtn.href = canvas.toDataURL('image/png');
                
                // 更新下载文件名以包含日期
                const dateStr = newsData.date.replace(/[年月日]/g, '');
                downloadBtn.download = `AI新闻海报_${dateStr}.png`;
                
                downloadBtn.style.display = 'inline-block';
            } catch (error) {
                console.error('生成海报图像时出错:', error);
                alert('生成海报时出现问题，请刷新页面重试。');
            }
        }
        
        function renderPosterWithoutLogo(ctx, canvas) {
            // 绘制背景
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#0a1929');
            gradient.addColorStop(0.5, '#0f2547');
            gradient.addColorStop(1, '#1e1033');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // 添加科技感线条和粒子
            drawTechPattern(ctx, canvas.width, canvas.height);
            
            // 绘制标题区背景
            ctx.fillStyle = 'rgba(0, 20, 50, 0.7)';
            ctx.fillRect(0, 40, canvas.width, 200);
            
            // 添加标题
            ctx.fillStyle = 'white';
            ctx.font = 'bold 62px "PingFang SC", "Microsoft YaHei", sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(newsData.date, canvas.width / 2, 120);
            
            ctx.font = 'bold 74px "PingFang SC", "Microsoft YaHei", sans-serif';
            // 创建渐变标题
            const titleGradient = ctx.createLinearGradient(200, 0, 800, 0);
            titleGradient.addColorStop(0, '#00aeff');  
            titleGradient.addColorStop(1, '#64eeff');
            ctx.fillStyle = titleGradient;
            
            // 添加轻微的标题阴影
            ctx.shadowColor = 'rgba(0, 174, 255, 0.6)';
            ctx.shadowBlur = 15;
            ctx.fillText('AI科技前沿速递', canvas.width / 2, 200);
            ctx.shadowBlur = 0;
            
            // 添加分隔线
            ctx.strokeStyle = 'rgba(0, 174, 255, 1)';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(50, 260);
            ctx.lineTo(canvas.width - 50, 260);
            ctx.stroke();
            
            try {
                // 绘制新闻框
                drawNewsBoxes(ctx, canvas);
            } catch (error) {
                console.error('绘制新闻框时出错:', error);
                // 即使绘制新闻框出错也要继续显示海报
            }
            
            try {
                // 显示生成的海报
                const posterImg = document.getElementById('ai-poster');
                try {
                    posterImg.src = canvas.toDataURL('image/png');
                } catch (securityError) {
                    console.error('Canvas安全错误:', securityError);
                    // 无法使用toDataURL，显示备用信息
                    displayFallbackPoster(canvas, posterImg);
                    return; // 提前返回，避免后续代码执行
                }
                posterImg.style.display = 'block';
                
                // 显示下载按钮
                const downloadBtn = document.getElementById('download-btn');
                downloadBtn.href = canvas.toDataURL('image/png');
                
                // 更新下载文件名以包含日期
                const dateStr = newsData.date.replace(/[年月日]/g, '');
                downloadBtn.download = `AI新闻海报_${dateStr}.png`;
                
                downloadBtn.style.display = 'inline-block';
            } catch (error) {
                console.error('生成海报图像时出错:', error);
                alert('生成海报时出现问题，请刷新页面重试。');
            }
        }
        
        // 当Canvas被标记为tainted无法导出时的备用函数
        function displayFallbackPoster(canvas, posterImg) {
            // 创建一个新的安全Canvas
            const safeCanvas = document.createElement('canvas');
            const safeCtx = safeCanvas.getContext('2d');
            safeCanvas.width = 500;  // 适合显示的尺寸
            safeCanvas.height = 800;
            
            // 绘制背景
            const gradient = safeCtx.createLinearGradient(0, 0, 0, safeCanvas.height);
            gradient.addColorStop(0, '#0a1929');
            gradient.addColorStop(0.5, '#0f2547');
            gradient.addColorStop(1, '#1e1033');
            safeCtx.fillStyle = gradient;
            safeCtx.fillRect(0, 0, safeCanvas.width, safeCanvas.height);
            
            // 添加文字说明
            safeCtx.fillStyle = 'white';
            safeCtx.font = 'bold 24px "PingFang SC", "Microsoft YaHei", sans-serif';
            safeCtx.textAlign = 'center';
            safeCtx.fillText(newsData.date, safeCanvas.width / 2, 50);
            
            // 添加标题
            safeCtx.font = 'bold 28px "PingFang SC", "Microsoft YaHei", sans-serif';
            safeCtx.fillStyle = '#00aeff';
            safeCtx.fillText('AI科技前沿速递', safeCanvas.width / 2, 100);
            
            // 添加提示信息
            safeCtx.font = '16px "PingFang SC", "Microsoft YaHei", sans-serif';
            safeCtx.fillStyle = 'white';
            safeCtx.fillText('因浏览器安全限制，无法显示完整海报', safeCanvas.width / 2, 150);
            safeCtx.fillText('请上传本地Logo或使用纯色背景', safeCanvas.width / 2, 180);

            // 添加主要新闻条目
            safeCtx.textAlign = 'left';
            safeCtx.font = 'bold 16px "PingFang SC", "Microsoft YaHei", sans-serif';
            safeCtx.fillStyle = '#00aeff';
            
            let yPos = 240;
            // 使用newsData中的新闻标题
            for (const item of newsData.items) {
                safeCtx.fillText(`${item.emoji} ${item.title}`, 30, yPos);
                yPos += 40;
            }
            
            // 添加哈希标签
            safeCtx.textAlign = 'center';
            safeCtx.font = 'bold 14px "PingFang SC", "Microsoft YaHei", sans-serif';
            const hashtagsStr = newsData.hashtags.slice(0, 3).map(tag => `#${tag}`).join(' '); // 限制显示的标签数量
            safeCtx.fillText(hashtagsStr, safeCanvas.width / 2, 550);
            
            // 显示备用海报
            try {
                posterImg.src = safeCanvas.toDataURL('image/png');
                posterImg.style.display = 'block';
                
                // 更新下载文件名以包含日期
                const dateStr = newsData.date.replace(/[年月日]/g, '');
                const downloadBtn = document.getElementById('download-btn');
                downloadBtn.download = `AI新闻海报_${dateStr}.png`;
            } catch (e) {
                // 如果还是出错，显示文本提示
                posterImg.style.display = 'none';
                alert('无法生成预览。请使用上传本地Logo图片重试。');
            }
            
            // 显示下载按钮(这里其实不能下载完整海报，但为了一致的用户体验)
            const downloadBtn = document.getElementById('download-btn');
            try {
                downloadBtn.href = safeCanvas.toDataURL('image/png');
                downloadBtn.style.display = 'inline-block';
                downloadBtn.textContent = '📲 下载预览海报';
            } catch (e) {
                downloadBtn.style.display = 'none';
            }
        }
        
        function drawTechPattern(ctx, width, height) {
            // 绘制科技感背景元素
            
            // 绘制网格点
            ctx.fillStyle = 'rgba(0, 174, 255, 0.1)';
            for (let i = 0; i < 200; i++) {
                const x = Math.random() * width;
                const y = Math.random() * height;
                const size = Math.random() * 3 + 1;
                ctx.beginPath();
                ctx.arc(x, y, size, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // 绘制连接线
            ctx.strokeStyle = 'rgba(0, 174, 255, 0.05)';
            ctx.lineWidth = 1;
            for (let i = 0; i < 30; i++) {
                const x1 = Math.random() * width;
                const y1 = Math.random() * height;
                const x2 = x1 + (Math.random() - 0.5) * 300;
                const y2 = y1 + (Math.random() - 0.5) * 300;
                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.stroke();
            }
            
            // 绘制光束效果
            for (let i = 0; i < 8; i++) {
                const x = Math.random() * width;
                const y = Math.random() * height;
                const gradient = ctx.createRadialGradient(x, y, 0, x, y, 350);
                gradient.addColorStop(0, 'rgba(0, 174, 255, 0.03)');
                gradient.addColorStop(1, 'rgba(0, 174, 255, 0)');
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(x, y, 350, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // 添加十字轴科技线
            ctx.strokeStyle = 'rgba(0, 174, 255, 0.04)';
            for (let i = 0; i < 15; i++) {
                const pos = Math.random() * width;
                ctx.beginPath();
                ctx.moveTo(pos, 0);
                ctx.lineTo(pos, height);
                ctx.stroke();
                
                const posY = Math.random() * height;
                ctx.beginPath();
                ctx.moveTo(0, posY);
                ctx.lineTo(width, posY);
                ctx.stroke();
            }
        }
        
        function drawNewsBoxes(ctx, canvas) {
            // 绘制新闻框背景和文字 - 更加科技感的设计
            function drawNewsItem(y, title, lines, emoji) {
                try {
                    // 计算框的高度 - 增加额外空间
                    const boxHeight = 100 + lines.length * 50;  // 增加高度，提供更多内部空间
                    
                    // 绘制背景框 - 渐变背景
                    const boxGradient = ctx.createLinearGradient(0, y, 0, y + boxHeight);
                    boxGradient.addColorStop(0, 'rgba(0, 40, 80, 0.6)');
                    boxGradient.addColorStop(1, 'rgba(0, 25, 50, 0.6)');
                    ctx.fillStyle = boxGradient;
                    
                    // 更大的框和圆角矩形
                    const boxWidth = canvas.width - 100;
                    const radius = 20;  // 增大圆角半径
                    roundRect(ctx, 50, y, boxWidth, boxHeight, radius, true, false);
                    
                    // 添加边框发光效果
                    ctx.strokeStyle = 'rgba(0, 174, 255, 0.3)';
                    ctx.lineWidth = 2;
                    roundRect(ctx, 50, y, boxWidth, boxHeight, radius, false, true);
                    
                    // 添加更宽的侧边装饰条
                    const decorGradient = ctx.createLinearGradient(0, y, 0, y + boxHeight);
                    decorGradient.addColorStop(0, '#00aeff');
                    decorGradient.addColorStop(1, '#0066ff');
                    ctx.fillStyle = decorGradient;
                    roundRect(ctx, 50, y, 10, boxHeight, {tl: radius, bl: radius, tr: 0, br: 0}, true, false);
                    
                    // 绘制标题 - 增加渐变和发光效果
                    const titleGradient = ctx.createLinearGradient(70, 0, 800, 0);
                    titleGradient.addColorStop(0, '#ffffff');
                    titleGradient.addColorStop(1, '#e0f7ff');
                    ctx.fillStyle = titleGradient;
                    ctx.font = 'bold 40px "PingFang SC", "Microsoft YaHei", sans-serif';  // 增大标题字体
                    ctx.textAlign = 'left';
                    
                    // 添加发光效果
                    ctx.shadowColor = 'rgba(0, 174, 255, 0.6)';
                    ctx.shadowBlur = 10;
                    ctx.fillText(`${emoji} ${title}`, 90, y + 60);  // 调整垂直位置
                    ctx.shadowBlur = 0;
                    
                    // 绘制内容 - 更清晰的文字，更大的字体和行距
                    ctx.fillStyle = '#ffffff';
                    ctx.font = '30px "PingFang SC", "Microsoft YaHei", sans-serif';  // 增大内容字体
                    for (let i = 0; i < lines.length; i++) {
                        ctx.fillText(lines[i], 90, y + 120 + (i * 45));  // 增加行距和起始位置
                    }
                } catch (error) {
                    console.error('绘制新闻项时出错:', error);
                    // 如果某条新闻渲染出错，继续绘制其他新闻
                }
            }
            
            // 绘制圆角矩形的辅助函数
            function roundRect(ctx, x, y, width, height, radius, fill, stroke) {
                try {
                    if (typeof radius === 'number') {
                        radius = {tl: radius, tr: radius, br: radius, bl: radius};
                    } else {
                        radius = {...{tl: 0, tr: 0, br: 0, bl: 0}, ...radius};
                    }
                    
                    ctx.beginPath();
                    ctx.moveTo(x + radius.tl, y);
                    ctx.lineTo(x + width - radius.tr, y);
                    ctx.quadraticCurveTo(x + width, y, x + width, y + radius.tr);
                    ctx.lineTo(x + width, y + height - radius.br);
                    ctx.quadraticCurveTo(x + width, y + height, x + width - radius.br, y + height);
                    ctx.lineTo(x + radius.bl, y + height);
                    ctx.quadraticCurveTo(x, y + height, x, y + height - radius.bl);
                    ctx.lineTo(x, y + radius.tl);
                    ctx.quadraticCurveTo(x, y, x + radius.tl, y);
                    ctx.closePath();
                    
                    if (fill) {
                        ctx.fill();
                    }
                    if (stroke) {
                        ctx.stroke();
                    }
                } catch (error) {
                    console.error('绘制圆角矩形时出错:', error);
                    // 出错时尝试绘制普通矩形替代
                    try {
                        ctx.beginPath();
                        ctx.rect(x, y, width, height);
                        if (fill) {
                            ctx.fill();
                        }
                        if (stroke) {
                            ctx.stroke();
                        }
                    } catch (fallbackError) {
                        console.error('备用矩形绘制也失败:', fallbackError);
                    }
                }
            }
            
            try {
                // 使用newsData中的新闻数据生成海报
                let yPosition = 300;
                const spacing = 220; // 每个新闻项之间的间距
                
                // 循环生成所有新闻项
                for (let i = 0; i < newsData.items.length; i++) {
                    const item = newsData.items[i];
                    drawNewsItem(
                        yPosition, 
                        item.title, 
                        item.content,
                        item.emoji
                    );
                    yPosition += spacing; // 为下一个新闻项增加垂直位置
                }
                
                // 添加底部标签背景 - 更加酷炫的设计
                try {
                    const tagY = yPosition + 50; // 在最后一条新闻下方添加标签
                    const tagGradient = ctx.createLinearGradient(0, tagY, 0, tagY + 80);
                    tagGradient.addColorStop(0, 'rgba(0, 40, 100, 0.7)');
                    tagGradient.addColorStop(1, 'rgba(30, 0, 60, 0.7)');
                    ctx.fillStyle = tagGradient;
                    roundRect(ctx, 50, tagY, canvas.width - 100, 80, 20, true, false);
                    
                    // 添加标签发光边框
                    ctx.strokeStyle = 'rgba(0, 174, 255, 0.3)';
                    ctx.lineWidth = 2;
                    roundRect(ctx, 50, tagY, canvas.width - 100, 80, 20, false, true);
                    
                    // 添加底部标签
                    const hashtagGradient = ctx.createLinearGradient(200, 0, 800, 0);
                    hashtagGradient.addColorStop(0, '#ffffff');
                    hashtagGradient.addColorStop(0.5, '#e0f7ff');
                    hashtagGradient.addColorStop(1, '#ffffff');
                    ctx.fillStyle = hashtagGradient;
                    ctx.font = 'bold 34px "PingFang SC", "Microsoft YaHei", sans-serif';
                    ctx.textAlign = 'center';
                    
                    // 添加发光效果
                    ctx.shadowColor = 'rgba(0, 174, 255, 0.6)';
                    ctx.shadowBlur = 10;
                    
                    // 将hashtags转换为格式化字符串
                    const hashtagsStr = newsData.hashtags.map(tag => `#${tag}`).join(' ');
                    ctx.fillText(hashtagsStr, canvas.width / 2, tagY + 50);
                    ctx.shadowBlur = 0;
                    
                    // 添加底部水印
                    ctx.font = '22px "PingFang SC", "Microsoft YaHei", sans-serif';
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                    ctx.fillText('AI新闻速递 · ' + new Date().toLocaleDateString('zh-CN'), canvas.width / 2, tagY + 120);
                    
                    // 添加底部科技元素装饰
                    ctx.strokeStyle = 'rgba(0, 174, 255, 0.15)';
                    ctx.lineWidth = 1;
                    
                    // 绘制一些随机的线条和圆点
                    for (let i = 0; i < 15; i++) {
                        const startX = Math.random() * canvas.width;
                        const startY = tagY + 150 + Math.random() * 100;
                        
                        ctx.beginPath();
                        ctx.moveTo(startX, startY);
                        ctx.lineTo(startX + Math.random() * 200 - 100, startY + Math.random() * 100);
                        ctx.stroke();
                        
                        ctx.beginPath();
                        ctx.arc(startX, startY, Math.random() * 4 + 1, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    
                    // 添加额外的科技感元素 - 电路板风格的图案
                    ctx.strokeStyle = 'rgba(0, 174, 255, 0.08)';
                    ctx.lineWidth = 1;
                    
                    // 绘制随机的电路图案
                    for (let i = 0; i < 8; i++) {
                        const startX = Math.random() * (canvas.width - 200) + 100;
                        const startY = tagY + 200;
                        
                        drawCircuitPath(ctx, startX, startY, 3 + Math.floor(Math.random() * 4), canvas);
                    }
                } catch (error) {
                    console.error('添加底部装饰时出错:', error);
                }
                
            } catch (error) {
                console.error('绘制新闻框时出错:', error);
            }
        }
        
        // 绘制电路板风格的路径
        function drawCircuitPath(ctx, x, y, steps, canvas) {
            try {
                if (!ctx || !canvas) {
                    console.error('无效的上下文或画布参数');
                    return;
                }

                ctx.beginPath();
                ctx.moveTo(x, y);
                
                let currentX = x;
                let currentY = y;
                
                for (let i = 0; i < steps; i++) {
                    // 随机决定方向 (0: 上, 1: 右, 2: 下, 3: 左)
                    const direction = Math.floor(Math.random() * 4);
                    const distance = 20 + Math.random() * 40;
                    
                    switch(direction) {
                        case 0: // 上
                            currentY -= distance;
                            break;
                        case 1: // 右
                            currentX += distance;
                            break;
                        case 2: // 下
                            currentY += distance;
                            break;
                        case 3: // 左
                            currentX -= distance;
                            break;
                    }
                    
                    // 确保路径在画布范围内
                    currentX = Math.max(50, Math.min(canvas.width - 50, currentX));
                    currentY = Math.max(y - 50, Math.min(y + 50, currentY));
                    
                    try {
                        ctx.lineTo(currentX, currentY);
                        
                        // 在拐角处添加小圆点
                        ctx.stroke();
                        
                        ctx.beginPath();
                        ctx.arc(currentX, currentY, 3, 0, Math.PI * 2);
                        ctx.fill();
                        
                        ctx.beginPath();
                        ctx.moveTo(currentX, currentY);
                    } catch (pathError) {
                        console.error('绘制电路路径节点时出错:', pathError);
                        // 重置路径避免累积错误
                        ctx.beginPath();
                        ctx.moveTo(currentX, currentY);
                    }
                }
                
                ctx.stroke();
            } catch (error) {
                console.error('绘制电路路径时出错:', error);
            }
        }
        
        // 生成一个纯色的logo图像（不会引起跨域问题）
        function generateColorLogo(ctx) {
            // 创建一个小型Canvas作为logo
            const logoCanvas = document.createElement('canvas');
            logoCanvas.width = 100;
            logoCanvas.height = 100;
            const logoCtx = logoCanvas.getContext('2d');
            
            // 绘制渐变背景
            const gradient = logoCtx.createLinearGradient(0, 0, 100, 100);
            gradient.addColorStop(0, '#00aeff');
            gradient.addColorStop(1, '#0066ff');
            logoCtx.fillStyle = gradient;
            logoCtx.fillRect(0, 0, 100, 100);
            
            // 绘制字母"AI"
            logoCtx.fillStyle = 'white';
            logoCtx.font = 'bold 50px Arial';
            logoCtx.textAlign = 'center';
            logoCtx.textBaseline = 'middle';
            logoCtx.fillText('AI', 50, 50);
            
            // 将Canvas转换为Image对象
            const logoImage = new Image();
            logoImage.src = logoCanvas.toDataURL('image/png');
            
            return logoImage;
        }
    </script>
</body>
</html>